<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¥µé€Ÿé»æ“Šç‹ Online - Ver 3.2 (Optimized)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Bungee&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    :root {
      --primary-color: #6c5ce7;
      --secondary-color: #a29bfe;
      --accent-color: #fd79a8;
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-color: #2d3436;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 500px;
      text-align: center;
    }

    h1 {
      font-family: 'Bungee', cursive;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      font-size: 2.5rem;
    }

    .status-bar {
      display: flex;
      justify-content: space-around;
      margin-bottom: 1.5rem;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 10px;
      font-weight: bold;
    }

    .nickname-section {
      margin-bottom: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .input-group {
      display: flex;
      gap: 10px;
      width: 100%;
      justify-content: center;
    }

    input {
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.3s;
      width: 60%;
    }

    input:focus {
      border-color: var(--primary-color);
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }

    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: #5b4bc4; transform: translateY(-2px); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

    .game-area {
      margin: 2rem 0;
      position: relative;
      display: flex;
      justify-content: center;
    }

    #clickBtn {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: radial-gradient(circle, var(--accent-color), #e84393);
      color: white;
      font-size: 1.5rem;
      border: 8px solid rgba(255,255,255,0.3);
      box-shadow: 0 8px 20px rgba(253, 121, 168, 0.4);
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #clickBtn:active {
      transform: scale(0.9);
    }

    .stats {
      display: flex;
      justify-content: space-between;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }

    .timer { color: #d63031; font-weight: bold; }
    .score { color: var(--primary-color); font-weight: bold; }

    .leaderboard-card {
      margin-top: 2rem;
      text-align: left;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 12px;
    }

    .leaderboard-card h3 {
      margin-top: 0;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .rank {
      width: 25px;
      height: 25px;
      background: var(--secondary-color);
      color: white;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
      font-size: 0.8rem;
      margin-right: 10px;
    }

    .combo-text {
      position: absolute;
      top: -40px;
      font-family: 'Bungee', cursive;
      color: var(--accent-color);
      font-size: 1.5rem;
      opacity: 0;
      pointer-events: none;
      transition: transform 0.2s, opacity 0.2s;
    }

    .show-combo { opacity: 1; transform: scale(1.2); }
  </style>
</head>
<body>
  <div class="container">
    <h1>CLICK KING</h1>
    <div class="status-bar">
      <span>åœ¨ç·š: <span id="onlineCount">0</span></span>
      <span id="nicknameHint" style="color: #636e72;">è«‹è¨­å®šæš±ç¨±</span>
    </div>

    <div class="nickname-section">
      <div class="input-group">
        <input type="text" id="nicknameInput" placeholder="è¼¸å…¥æš±ç¨±..." maxlength="10">
        <button id="saveNicknameBtn" class="btn-primary">è¨­å®š</button>
      </div>
      <button id="editNicknameBtn" style="display:none; font-size: 0.8rem; background: none; color: var(--primary-color); text-decoration: underline;">ä¿®æ”¹æš±ç¨±</button>
    </div>

    <div class="stats">
      <div>æ™‚é–“: <span class="timer" id="timeDisplay">10</span>s</div>
      <div>å¾—åˆ†: <span class="score" id="scoreDisplay">0</span></div>
    </div>

    <div class="game-area">
      <div id="comboText" class="combo-text">COMBO X1</div>
      <button id="clickBtn" disabled>é»æˆ‘ï¼</button>
    </div>

    <div id="result" style="font-weight: bold; color: var(--accent-color); margin: 10px 0; min-height: 1.2em;"></div>

    <div style="display: flex; gap: 10px; justify-content: center;">
      <button id="startBtn" class="btn-primary" disabled>é–‹å§‹éŠæˆ²</button>
      <button id="resetBtn" style="background: #636e72; color: white;">é‡ç½®</button>
    </div>

    <div class="leaderboard-card">
      <h3>ğŸ† ä¸–ç•Œæ’è¡Œæ¦œ (Top 10)</h3>
      <ul id="leaderboard">
        <li>è¼‰å…¥ä¸­...</li>
      </ul>
      <p id="bestScoreText" style="font-size: 0.85rem; color: #636e72; margin-top: 10px;"></p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCcTZY_Fike_D_Dnav9SnaLpwLziEQeu8s",
      authDomain: "click-game-ad813.firebaseapp.com",
      projectId: "click-game-ad813",
      storageBucket: "click-game-ad813.firebasestorage.app",
      messagingSenderId: "738808291812",
      appId: "1:738808291812:web:c60d1125397d1c7be3e7f1",
      measurementId: "G-JK5M4VCQDT",
      databaseURL: "https://click-game-ad813-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const userId = "user_" + Math.random().toString(36).slice(2);
    let currentNickname = "";
    let score = 0;
    let timeLeft = 10;
    let timerId = null;
    let isGameStarted = false;
    let combo = 1;
    let lastClickTime = 0;

    const clickBtn = document.getElementById("clickBtn");
    const scoreDisplay = document.getElementById("scoreDisplay");
    const timeDisplay = document.getElementById("timeDisplay");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const resultDiv = document.getElementById("result");
    const nicknameInput = document.getElementById("nicknameInput");
    const saveNicknameBtn = document.getElementById("saveNicknameBtn");
    const editNicknameBtn = document.getElementById("editNicknameBtn");
    const nicknameHint = document.getElementById("nicknameHint");
    const onlineCountEl = document.getElementById("onlineCount");
    const leaderboardEl = document.getElementById("leaderboard");
    const bestScoreText = document.getElementById("bestScoreText");
    const comboText = document.getElementById("comboText");

    const onlineRef = db.ref("onlineUsers/" + userId);

    saveNicknameBtn.addEventListener("click", () => {
      const name = nicknameInput.value.trim();
      if (!name) return alert("è«‹è¼¸å…¥æš±ç¨±ï¼");
      currentNickname = name;
      updateNicknameUI(true);
      
      onlineRef.set({ 
        name: currentNickname, 
        lastActive: firebase.database.ServerValue.TIMESTAMP 
      });
      onlineRef.onDisconnect().remove();
      startBtn.disabled = false;
    });

    editNicknameBtn.addEventListener("click", () => {
      updateNicknameUI(false);
    });

    function updateNicknameUI(isSet) {
      if (isSet) {
        nicknameHint.textContent = `ç©å®¶ï¼š${currentNickname}`;
        nicknameHint.style.color = "#6c5ce7";
        nicknameInput.style.display = "none";
        saveNicknameBtn.style.display = "none";
        editNicknameBtn.style.display = "inline-block";
      } else {
        nicknameHint.textContent = "è«‹è¨­å®šæš±ç¨±";
        nicknameHint.style.color = "#636e72";
        nicknameInput.style.display = "inline-block";
        saveNicknameBtn.style.display = "inline-block";
        editNicknameBtn.style.display = "none";
        startBtn.disabled = true;
      }
    }

    clickBtn.addEventListener("click", () => {
      if (!isGameStarted) return;
      
      const now = Date.now();
      if (now - lastClickTime < 250) {
        combo++;
      } else {
        combo = 1;
      }
      lastClickTime = now;

      if (combo >= 2) {
        comboText.textContent = `COMBO X${combo}`;
        comboText.classList.add("show-combo");
        clearTimeout(window.comboTimeout);
        window.comboTimeout = setTimeout(() => {
          comboText.classList.remove("show-combo");
          combo = 1;
        }, 500);
      }

      const bonus = Math.floor(combo / 5);
      score += (1 + bonus);
      scoreDisplay.textContent = score;
      
      clickBtn.style.transform = "scale(0.92)";
      setTimeout(() => clickBtn.style.transform = "scale(1)", 50);
    });

    startBtn.addEventListener("click", () => {
      if (isGameStarted) return;
      startGame();
    });

    resetBtn.addEventListener("click", resetGame);

    function startGame() {
      isGameStarted = true;
      score = 0;
      timeLeft = 10;
      combo = 1;
      scoreDisplay.textContent = score;
      timeDisplay.textContent = timeLeft;
      clickBtn.disabled = false;
      startBtn.disabled = true;
      editNicknameBtn.style.visibility = "hidden";
      resultDiv.textContent = "GO!";

      timerId = setInterval(() => {
        timeLeft--;
        timeDisplay.textContent = timeLeft;
        if (timeLeft <= 0) endGame();
      }, 1000);
    }

    function endGame() {
      clearInterval(timerId);
      isGameStarted = false;
      clickBtn.disabled = true;
      startBtn.disabled = false;
      editNicknameBtn.style.visibility = "visible";
      comboText.classList.remove("show-combo");
      resultDiv.textContent = `ä¸Šå‚³æˆç¸¾ä¸­...`;

      if (currentNickname && score > 0) {
        // ä½¿ç”¨ push().set() ä¸¦ç›£è½å®Œæˆå›èª¿
        const newScoreRef = db.ref("scores").push();
        newScoreRef.set({
          name: currentNickname,
          score: score,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        }, (error) => {
          if (error) {
            resultDiv.textContent = `ä¸Šå‚³å¤±æ•—ï¼š${error.message}`;
          } else {
            resultDiv.textContent = `æ™‚é–“åˆ°ï¼æœ€çµ‚å¾—åˆ†ï¼š${score}`;
            // å¼·åˆ¶åˆ·æ–°æ’è¡Œæ¦œé¡¯ç¤º
            refreshLeaderboard();
          }
        });
      } else {
        resultDiv.textContent = `æ™‚é–“åˆ°ï¼å¾—åˆ†ï¼š${score}`;
      }
    }

    function resetGame() {
      clearInterval(timerId);
      isGameStarted = false;
      score = 0;
      timeLeft = 10;
      timeDisplay.textContent = timeLeft;
      scoreDisplay.textContent = score;
      clickBtn.disabled = true;
      startBtn.disabled = !currentNickname;
      editNicknameBtn.style.visibility = "visible";
      resultDiv.textContent = "";
      comboText.classList.remove("show-combo");
    }

    // æ•¸æ“šç›£è½
    db.ref("onlineUsers").on("value", (snap) => {
      const data = snap.val() || {};
      onlineCountEl.textContent = Object.keys(data).length;
    });

    // å°‡æ’è¡Œæ¦œé‚è¼¯å°è£ï¼Œä»¥ä¾¿æ‰‹å‹•è§¸ç™¼
    function refreshLeaderboard() {
      db.ref("scores").orderByChild("score").limitToLast(10).once("value", (snap) => {
        updateLeaderboardUI(snap);
      });
    }

    // æŒçºŒç›£è½æ’è¡Œæ¦œ
    db.ref("scores").orderByChild("score").limitToLast(10).on("value", (snap) => {
      updateLeaderboardUI(snap);
    });

    function updateLeaderboardUI(snap) {
      const list = [];
      snap.forEach(child => {
        list.push(child.val());
      });
      // Firebase limitToLast è¿”å›çš„æ˜¯å‡åºï¼Œæˆ‘å€‘éœ€è¦é™åº
      list.sort((a, b) => b.score - a.score);
      
      leaderboardEl.innerHTML = list.map((item, i) => `
        <li>
          <span><span class="rank">${i+1}</span>${escapeHtml(item.name)}</span>
          <span style="color:var(--primary-color); font-weight:bold;">${item.score} æ¬¡</span>
        </li>
      `).join("") || "<li>å°šç„¡æ•¸æ“š</li>";

      if (list.length > 0) {
        bestScoreText.innerHTML = `ğŸ”¥ æœ€é«˜ç´€éŒ„ï¼š${list[0].score} æ¬¡ (${escapeHtml(list[0].name)})`;
      }
    }

    setInterval(() => {
      if (currentNickname) {
        onlineRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      }
    }, 10000);

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
