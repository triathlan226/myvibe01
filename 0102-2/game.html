<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®®é—ˆæ®˜å±€â€”â€”é³³å‡°æµ´ç«éŒ„ (æœ€çµ‚ä¿®å¾©ç‰ˆ)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');

        :root {
            --royal-red: #8B0000;
            --royal-gold: #DAA520;
            --paper-bg: #F5F5DC;
            --ink-black: #2F2F2F;
            --faded-border: #D2B48C;
            --item-bg: #e8dcc5;
        }

        /* å…¨å±€é‡ç½® */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif TC', 'Songti TC', 'PMingLiU', serif;
            background-color: #2a2a2a;
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23333" fill-opacity="0.1"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--ink-black);
            overflow: hidden; 
        }

        /* éŠæˆ²ä¸»å®¹å™¨ */
        .game-container {
            width: 100%;
            max-width: 800px;
            height: 98vh;
            background-color: var(--paper-bg);
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            border: 8px solid var(--royal-red);
            border-radius: 4px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .game-container::before {
            content: "";
            position: absolute;
            top: 4px; left: 4px; right: 4px; bottom: 4px;
            border: 2px solid var(--royal-gold);
            pointer-events: none;
            z-index: 10;
        }

        /* é ‚éƒ¨å±¬æ€§æ¬„ */
        .stats-bar {
            background: linear-gradient(to bottom, #4a0000, #2b0000);
            color: #fff;
            padding: 8px;
            border-bottom: 2px solid var(--royal-gold);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            font-size: 0.8rem;
            z-index: 20;
            flex-shrink: 0;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            padding: 3px 6px;
            min-width: 55px;
        }

        .stat-label { color: #ccc; font-size: 0.65rem; margin-bottom: 2px; }
        .stat-value { font-weight: bold; color: var(--royal-gold); font-family: monospace; }

        /* é“å…·æ¬„ */
        .inventory-bar {
            background: #d4c5a9;
            padding: 5px 15px;
            border-bottom: 1px solid var(--faded-border);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            flex-shrink: 0;
            z-index: 18;
            min-height: 36px;
        }
        
        .inv-label { font-weight: bold; color: var(--royal-red); margin-right: 5px; }
        .inv-item {
            background: #fff;
            border: 1px solid #8c7b70;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #4a3b32;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* åŠ‡æƒ…å€ */
        .story-area {
            flex: 1;
            min-height: 0; /* é—œéµï¼šè®“ flex item å¯ä»¥ç¸®å° */
            padding: 20px 30px;
            overflow-y: auto;
            font-size: 1.1rem;
            line-height: 1.8;
            text-align: justify;
            z-index: 15;
            position: relative;
        }

        .story-area::-webkit-scrollbar { width: 8px; }
        .story-area::-webkit-scrollbar-thumb { background: var(--faded-border); border-radius: 4px; }
        .story-area::-webkit-scrollbar-thumb:hover { background: var(--royal-gold); }

        .highlight-danger { color: #991b1b; font-weight: bold; }
        .highlight-success { color: #2e7d32; font-weight: bold; }

        .event-log {
            font-size: 0.95rem;
            color: #555;
            margin: 15px 0;
            font-style: italic;
            border-left: 3px solid var(--royal-gold);
            padding-left: 12px;
            background: rgba(218, 165, 32, 0.1);
            padding: 8px 12px;
            border-radius: 0 4px 4px 0;
            animation: fadeIn 0.5s;
        }

        .npc-tag {
            font-weight: bold;
            color: var(--royal-red);
            margin-right: 3px;
            background: rgba(139, 0, 0, 0.05);
            padding: 0 4px;
            border-radius: 3px;
        }

        /* é¸é …å€ - é—œéµä¿®å¾©ï¼šé™åˆ¶é«˜åº¦èˆ‡æ²å‹• */
        .choices-area {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid var(--faded-border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 20;
            flex-shrink: 0; /* é˜²æ­¢è¢«æ“ å£“ */
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            
            /* æ–°å¢ï¼šé˜²æ­¢æŒ‰éˆ•éå¤šæ™‚æ’ç ´ç•«é¢ */
            max-height: 45vh; 
            overflow-y: auto;
        }
        
        /* é¸é …å€æ²è»¸æ¨£å¼ */
        .choices-area::-webkit-scrollbar { width: 6px; }
        .choices-area::-webkit-scrollbar-track { background: transparent; }
        .choices-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        .choice-btn {
            background: linear-gradient(to bottom, #fffdf5, #efe8d8);
            border: 2px solid #8c7b70;
            color: #4a3b32;
            padding: 10px 14px;
            text-align: left;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-family: 'Noto Serif TC', serif;
            font-weight: bold;
            font-size: 0.95rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* æŒ‰éˆ•æœ¬èº«ä¸å£“ç¸® */
        }
        
        .choice-btn-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .choice-btn:hover:not(:disabled) {
            background: #fff;
            border-color: var(--royal-red);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(139, 0, 0, 0.2);
        }

        .choice-btn:disabled {
            background: #e0e0e0;
            border-color: #ccc;
            color: #999;
            cursor: not-allowed;
            opacity: 0.8;
        }

        .choice-req { font-size: 0.8rem; color: var(--royal-red); font-weight: normal; }
        .choice-effect { font-size: 0.75rem; color: #666; margin-top: 4px; font-weight: normal; }
        
        .req-item { color: #8B4513; font-weight: bold; font-size: 0.8rem; }

        .float-text {
            position: absolute;
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            animation: floatUp 1.5s forwards;
            z-index: 100;
            text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* æ¨™é¡Œç•«é¢ */
        .title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--royal-red);
            background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="%239c0000" fill-opacity="0.4" fill-rule="evenodd"%3E%3Ccircle cx="3" cy="3" r="3"/%3E%3Ccircle cx="13" cy="13" r="3"/%3E%3C/g%3E%3C/svg%3E');
            z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: var(--royal-gold); text-align: center; padding: 20px;
        }
        
        .title-main {
            font-size: 2.5rem; font-weight: bold; margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            border: 4px double var(--royal-gold); padding: 20px 40px;
            background: rgba(0,0,0,0.3);
        }

        .start-btn {
            padding: 15px 40px; font-size: 1.2rem; background: var(--royal-gold);
            color: var(--royal-red); border: 2px solid #fff; cursor: pointer;
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s; margin-top: 20px;
        }
        .start-btn:hover { transform: scale(1.05); }
        .hidden { display: none !important; }

        /* RWD */
        @media (max-width: 600px) {
            .stats-bar { gap: 4px; padding: 5px; }
            .stat-item { padding: 2px 4px; min-width: 45px; }
            .stat-label { font-size: 0.6rem; }
            .stat-value { font-size: 0.75rem; }
            .game-container { height: 100vh; max-height: 100vh; border-width: 0; border-top: 5px solid var(--royal-red); border-radius: 0; }
            .choices-area { padding: 10px 15px; max-height: 50vh; }
            .inventory-bar { padding: 5px 10px; font-size: 0.75rem; min-height: 30px; overflow-x: auto; white-space: nowrap; }
        }
        
        .val-up { color: #2e7d32; font-weight: bold; }
        .val-down { color: #c62828; font-weight: bold; }
    </style>
</head>
<body>

<div class="game-container">
    <div id="titleScreen" class="title-screen">
        <div class="title-main">å®®é—ˆæ®˜å±€<br><span style="font-size: 1.5rem; font-weight: normal; letter-spacing: 5px;">é³³å‡°æµ´ç«éŒ„</span></div>
        <div style="background: rgba(0,0,0,0.4); padding: 20px; border-radius: 8px; max-width: 600px; color: #fff;">
            <p style="margin-bottom: 10px; line-height: 1.6;">
                æ›¾æ¬Šå‚¾ä¸€æ™‚çš„è²´å¦ƒï¼Œå¦‚ä»Šæ·±é™·æ³¥æ½­ã€‚<br>
                åœ¨å±æ©Ÿå››ä¼çš„å¾Œå®®ï¼Œå”¯æœ‰æ­¥æ­¥ç‚ºç‡Ÿï¼Œæ–¹èƒ½é³³å‡°æ¶…æ§ƒã€‚
            </p>
            <p style="font-size: 0.9rem; opacity: 0.9; margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.3); padding-top: 10px;">
                ğŸ’¡ æœ€çµ‚ä¿®å¾©ï¼šè§£æ±ºå¾ŒæœŸé¸é …éå¤šå°è‡´çš„ç‰ˆé¢å•é¡Œèˆ‡åˆ¤å®š Bugã€‚
            </p>
        </div>
        <button class="start-btn" onclick="startGame()">å…¥å®®ç ´å±€</button>
    </div>

    <div class="stats-bar" id="statsBar"></div>
    <div class="inventory-bar" id="inventoryBar">
        <span class="inv-label">è¡Œå›Š:</span>
        <span id="invList" style="display:flex; gap:5px;">ç„¡</span>
    </div>
    <div class="story-area" id="storyArea">
        <div id="storyContent"></div>
    </div>
    <div class="choices-area" id="choicesArea"></div>
</div>

<script>
    const initialStats = {
        favor: 50, prestige: 50, cunning: 50, health: 50, beauty: 60, family: 40, connection: 30
    };

    const statLabels = {
        favor: "ğŸ‘‘ è–å¯µ", prestige: "ğŸ’ å¨æœ›", cunning: "ğŸ¦Š å¿ƒæ©Ÿ",
        health: "ğŸ’– é«”è³ª", beauty: "ğŸŒ¹ ç¾è²Œ", family: "ğŸ›ï¸ å®¶æ—", connection: "ğŸ•¸ï¸ äººè„ˆ"
    };

    let currentState = { ...initialStats };
    let currentInventory = [];
    let currentSceneId = "background_selection";

    const scenes = {
        "background_selection": {
            text: `<p><strong>ã€åºç« ï¼šå‰å¡µå¾€äº‹ã€‘</strong></p><p>å…¥å®®ä¹‹å‰ï¼Œä½ æœ¬æ˜¯â€¦â€¦</p>`,
            choices: [
                {
                    text: "å°‡é–€è™å¥³ - æ€§æ ¼å‰›çƒˆï¼Œé«”é­„å¼·å¥",
                    effect: { health: 20, family: 20, cunning: -10, beauty: -5 },
                    nextScene: "start", gainItem: "å‚³å®¶ç‰ä½©"
                },
                {
                    text: "æ›¸é¦™ä¸–å®¶ - åšè¦½ç¾¤æ›¸ï¼Œå¿ƒæ€ç¸å¯†",
                    effect: { cunning: 20, prestige: 10, health: -10, family: -5 },
                    nextScene: "start", gainItem: "é†«æ›¸æ®˜å·"
                },
                {
                    text: "æ±Ÿå—åå¦“ - è±”å† ç¾¤èŠ³ï¼Œå…«é¢ç²ç“",
                    effect: { beauty: 25, favor: 10, connection: 15, prestige: -20, family: -20 },
                    nextScene: "start", gainItem: "è¿·æƒ…é¦™"
                }
            ]
        },
        "start": {
            text: `<p><strong>ç¬¬ä¸€ç« ï¼šé¢¨é›¨æ¬²ä¾†</strong></p><p>ã€Œ${getAppellation()}ï¼Œä½ çˆ¶è¦ªè¢«å½ˆåŠ¾è²ªæ±¡ï¼Œä½ æœ‰ä½•è©±èªªï¼Ÿã€</p>`,
            choices: [
                {
                    text: "å“­è¨´å†¤æ‰ï¼ŒæåŠèˆŠæƒ…",
                    effect: { favor: 5, prestige: -10 },
                    nextScene: "scene_1_mercy"
                },
                {
                    text: "ä¸å‘ä¸äº¢ï¼Œæ“šç†åŠ›çˆ­",
                    effect: { favor: -10, prestige: 5, cunning: 5 },
                    nextScene: "scene_1_argue"
                },
                {
                    text: "ç¦æ°´æ±å¼• (å¿ƒæ©Ÿåˆ¤å®š)",
                    isRisk: true, riskStat: "cunning",
                    successScene: "scene_1_scheme", failScene: "scene_1_mercy",
                    resultText: "ä½ è©¦åœ–è½‰ç§»ç„¦é»ï¼Œä½†èªæ°£ç•¥é¡¯æ…Œå¼µã€‚",
                    effect: { cunning: 2 }
                },
                {
                    text: "ã€é“å…·ï¼šå‚³å®¶ç‰ä½©ã€‘å‘ˆä¸Šå…ˆå¸å¾¡è³œç‰ä½©",
                    reqItem: "å‚³å®¶ç‰ä½©",
                    effect: { favor: 10, prestige: 20 },
                    nextScene: "scene_1_scheme"
                }
            ]
        },
        "scene_1_mercy": {
            text: `<p>çš‡ä¸Šç¦äº†ä½ çš„è¶³ã€‚å®®å¥³é€ä¾†ä¸€ç¢—æ•£ç™¼è‹¦å‘³çš„å®‰ç¥æ¹¯ã€‚</p>`,
            choices: [
                {
                    text: "å–ä¸‹ (é«”è³ªåˆ¤å®š)",
                    isRisk: true, riskStat: "health",
                    successScene: "scene_2_poison_resist", failScene: "scene_2_poison_fail",
                    effect: { health: -5 }
                },
                {
                    text: "ã€é“å…·ï¼šé†«æ›¸æ®˜å·ã€‘æŸ¥é©—è—¥æ¸£",
                    reqItem: "é†«æ›¸æ®˜å·",
                    effect: { cunning: 10, prestige: 5 },
                    nextScene: "scene_2_expose", gainItem: "æœ‰æ¯’è—¥æ¸£"
                },
                {
                    text: "å·å·å€’æ‰",
                    effect: { cunning: 5 },
                    resultText: "ä½ å°‡è—¥å€’é€²èŠ±ç›†ï¼ŒèŠ±æ¯èäº†ã€‚",
                    nextScene: "scene_daily_intro"
                }
            ]
        },
        "scene_1_argue": {
            text: `<p>è¢«é™ä½å¾Œï¼Œä½ åœ¨å¾¡èŠ±åœ’é‡è¦‹å¤ªé†«æº«å¯¦åˆã€‚</p>`,
            choices: [
                {
                    text: "ç´¢è¦è£œè—¥",
                    effect: { health: 10, connection: 5 },
                    nextScene: "scene_daily_intro", gainItem: "é¤Šèº«ä¸¸"
                },
                {
                    text: "ä¿æŒè·é›¢",
                    effect: { prestige: 5 },
                    nextScene: "scene_daily_intro"
                }
            ]
        },
        "scene_1_scheme": {
            text: `<p>å¯†ä¿¡è­¦å‘Šï¼šæ˜æ—¥å¾¡èŠ±åœ’æœ‰é™·é˜±ã€‚</p>`,
            choices: [
                {
                    text: "å‰å¾€ä¸€æ¢ (å¿ƒæ©Ÿåˆ¤å®š)",
                    isRisk: true, riskStat: "cunning",
                    successScene: "scene_3_trap_success", failScene: "scene_3_trap_fail"
                },
                {
                    text: "æŒ‰å…µä¸å‹•",
                    effect: { cunning: 5 },
                    nextScene: "scene_daily_intro"
                }
            ]
        },
        "scene_2_poison_fail": {
            text: `<p class="highlight-danger">ä½ ä¸­æ¯’äº†ï¼Œå…ƒæ°£å¤§å‚·ï¼</p>`,
            choices: [{ text: "æ™æ‰æ±‚ç”Ÿ", effect: { health: -25, beauty: -10 }, nextScene: "scene_daily_intro" }]
        },
        "scene_2_poison_resist": {
            text: `<p>ä½ æ‰›ä½äº†æ¯’æ€§ï¼Œä½†ä»éœ€èª¿é¤Šã€‚</p>`,
            choices: [{ text: "èª¿é¤Š", effect: { health: -5 }, nextScene: "scene_daily_intro" }]
        },
        "scene_2_expose": {
            text: `<p>ä½ ç™¼ç¾äº†è˜­å¬ªä¸‹æ¯’çš„è­‰æ“šã€‚</p>`,
            choices: [{ text: "æ”¶å¥½è­‰æ“š", effect: { prestige: 10 }, nextScene: "scene_daily_intro", gainItem: "è˜­å¬ªç½ªè­‰" }]
        },
        "scene_3_trap_success": {
            text: `<p>ä½ åå°‡ä¸€è»ï¼Œè˜­å¬ªè¢«ç½°ã€‚</p>`,
            choices: [{ text: "å¤§å¿«äººå¿ƒ", effect: { prestige: 15, favor: 10 }, nextScene: "scene_daily_intro" }]
        },
        "scene_3_trap_fail": {
            text: `<p>ä¸­è¨ˆäº†ï¼ä½ è¢«èª¤æœƒç§æœƒä¾è¡›ã€‚</p>`,
            choices: [{ text: "ç™¾å£è«è¾¯", effect: { favor: -15, prestige: -15 }, nextScene: "scene_daily_intro" }]
        },
        "scene_daily_intro": {
            text: `<p><strong>ã€å®®å»·æ—¥å¸¸ï¼šéŸœå…‰é¤Šæ™¦ã€‘</strong></p><p>å¤ªåå£½å®´åœ¨å³ï¼Œä½ éœ€è¦åšæº–å‚™ã€‚</p>`,
            choices: [{ text: "é–‹å§‹è¦åŠƒ", nextScene: "scene_daily_action_1" }]
        },
        "scene_daily_action_1": {
            text: `<p>ä»Šæ—¥é¢¨å’Œæ—¥éº—ï¼Œä½ è¦åšä»€éº¼ï¼Ÿ</p>`,
            choices: [
                { text: "ç ”è®€é†«æ›¸ (å‡å¿ƒæ©Ÿ)", effect: { cunning: 8, health: -2 }, nextScene: "scene_daily_action_2" },
                { text: "å°é¡è²¼èŠ±é»ƒ (å‡ç¾è²Œ)", effect: { beauty: 8, favor: 2 }, nextScene: "scene_daily_action_2" },
                { text: "è³„è³‚å¾¡è†³æˆ¿ (å‡äººè„ˆ)", effect: { connection: 8, family: -5 }, nextScene: "scene_daily_action_2", gainItem: "å¤ªåæƒ…å ±" },
                { text: "ã€é“å…·ï¼šé¤Šèº«ä¸¸ã€‘æœç”¨", reqItem: "é¤Šèº«ä¸¸", effect: { health: 15, beauty: 5 }, removeItem: "é¤Šèº«ä¸¸", nextScene: "scene_daily_action_2" }
            ]
        },
        "scene_daily_action_2": {
            text: `<p>å¤œæ·±äº†ï¼Œä½ æ±ºå®šâ€¦â€¦</p>`,
            choices: [
                { text: "è‹¦ç·´é©šé´»èˆ (é«”è³ªåˆ¤å®š)", isRisk: true, riskStat: "health", successScene: "scene_daily_result_dance", failScene: "scene_daily_result_tired", effect: { beauty: 5 } },
                { text: "åˆºç¹¡ä½›ç¶“ (å‡å¨æœ›)", effect: { prestige: 5, cunning: 3 }, nextScene: "scene_4_banquet_start" },
                { text: "ã€é“å…·ï¼šè¿·æƒ…é¦™ã€‘è©¦ç”¨", reqItem: "è¿·æƒ…é¦™", effect: { favor: 10, beauty: 5 }, removeItem: "è¿·æƒ…é¦™", nextScene: "scene_4_banquet_start" }
            ]
        },
        "scene_daily_result_dance": {
            text: `<p>èˆè—å¤§é€²ï¼</p>`,
            choices: [{ text: "è¿æ¥å£½å®´", nextScene: "scene_4_banquet_start", gainItem: "ç²¾æ¹›èˆæŠ€" }]
        },
        "scene_daily_result_tired": {
            text: `<p>é«”åŠ›ä¸æ”¯æ‰­å‚·äº†è…³ã€‚</p>`,
            choices: [{ text: "ä¼‘æ¯", effect: { health: -10, beauty: -5 }, nextScene: "scene_4_banquet_start" }]
        },
        "scene_4_banquet_start": {
            text: `<p><strong>ç¬¬äºŒç« ï¼šå¤ªåå£½å®´</strong></p><p>é€™æ˜¯å±•ç¾è‡ªæˆ‘çš„æ©Ÿæœƒã€‚</p>`,
            choices: [
                {
                    text: "ã€é“å…·ï¼šç²¾æ¹›èˆæŠ€ã€‘ç»èˆé©šé´»",
                    reqItem: "ç²¾æ¹›èˆæŠ€",
                    effect: { favor: 25, prestige: 15 },
                    nextScene: "scene_5_emperor_sick"
                },
                {
                    text: "ç»èˆ (ç¾è²Œåˆ¤å®š)",
                    isRisk: true, riskStat: "beauty",
                    successScene: "scene_5_emperor_sick", failScene: "scene_5_emperor_sick", 
                    effect: { favor: 5 },
                    resultText: "ä½ ç›¡åŠ›ä¸€èˆï¼Œé›–ç„¡é©šè±”å…¨å ´ï¼Œä½†ä¹Ÿç®—å¾—é«”ã€‚" // æˆåŠŸæ–‡æœ¬
                },
                {
                    text: "ã€é“å…·ï¼šå¤ªåæƒ…å ±ã€‘èŠä½›æ³•",
                    reqItem: "å¤ªåæƒ…å ±",
                    effect: { prestige: 20, connection: 10, favor: 5 },
                    nextScene: "scene_5_emperor_sick"
                },
                {
                    text: "ä½èª¿ä¸å‡ºéŒ¯",
                    effect: { connection: 5 },
                    nextScene: "scene_5_emperor_sick"
                }
            ]
        },
        "scene_5_emperor_sick": {
            text: `<p><strong>ç¬¬ä¸‰ç« ï¼šæœ€çµ‚æ±ºæˆ°</strong></p><p>çš‡ä¸Šç—…é‡ï¼Œè˜­å¬ªèª£é™·ä½ ã€‚é€™æ˜¯ç”Ÿæ­»é—œé ­ã€‚</p>`,
            choices: [
                {
                    text: "ã€é“å…·ï¼šè˜­å¬ªç½ªè­‰ã€‘ç•¶çœ¾æ­ç™¼ (å¿…å‹)",
                    reqItem: "è˜­å¬ªç½ªè­‰", effect: { prestige: 30, favor: 30 },
                    nextScene: "ending_empress"
                },
                {
                    text: "ã€é“å…·ï¼šé†«æ›¸æ®˜å·ã€‘è‡ªè­‰æ¸…ç™½ (éœ€é†«è¡“)",
                    reqItem: "é†«æ›¸æ®˜å·", effect: { favor: 40, prestige: 20 },
                    nextScene: "ending_favorite"
                },
                {
                    text: "ã€è–å¯µ > 60ã€‘å“­è¨´æ±‚æƒ…", // é–€æª»é™ä½
                    requirement: { stat: "favor", val: 60 }, effect: { prestige: -10 },
                    nextScene: "ending_peace" 
                },
                {
                    text: "ã€å®¶æ— > 60ã€‘å‰æœæ–½å£“",
                    requirement: { stat: "family", val: 60 }, effect: { favor: -10, prestige: 10 },
                    nextScene: "ending_peace"
                },
                {
                    text: "å†’éšªåæ“Š (å¿ƒæ©Ÿåˆ¤å®š)", 
                    isRisk: true, riskStat: "cunning",
                    successScene: "scene_6_scheme_success", failScene: "ending_death",
                    effect: { cunning: 5 }
                },
                {
                    text: "ç«­åŠ›å‘¨æ—‹ (é€šç”¨é¸é …)", 
                    effect: { health: -10 },
                    resultText: "ä½ æ‹¼æ­»è¾¯è§£ï¼Œé›–æœªæ´—æ¸…å†¤å±ˆï¼Œä½†æš«æ™‚ä¿ä½ä¸€å‘½æ‰“å…¥å†·å®®ã€‚",
                    nextScene: "ending_cold"
                }
            ]
        },
        "scene_6_scheme_success": {
            text: "<p>ä½ è¨­è¨ˆè®“è˜­å¬ªã€æ„å¤–ã€å°ç”¢ï¼Œçš‡ä¸Šå­æ£„äº†å¥¹ã€‚</p>",
            choices: [{ text: "æŸ¥çœ‹çµå±€", nextScene: "ending_favorite" }]
        },
        "ending_empress": {
            text: `<p style="color:var(--royal-gold);font-size:1.5rem;">ã€çµå±€ï¼šé³³è‡¨å¤©ä¸‹ã€‘</p><p>ä½ è¢«å†Šç«‹ç‚ºåã€‚</p>`,
            choices: [{ text: "å†å…¥å®®é–€", action: "restart" }]
        },
        "ending_favorite": {
            text: `<p style="color:var(--royal-red);font-size:1.5rem;">ã€çµå±€ï¼šç››ä¸–å¯µå¦ƒã€‘</p><p>ä½ æˆç‚ºçš‡ä¸Šæœ€ä¿¡ä»»çš„äººã€‚</p>`,
            choices: [{ text: "å†å…¥å®®é–€", action: "restart" }]
        },
        "ending_peace": {
            text: `<p style="color:#2E8B57;font-size:1.5rem;">ã€çµå±€ï¼šæ­²æœˆéœå¥½ã€‘</p><p>ä½ ä¿ä½äº†åœ°ä½ï¼Œå®‰ç©©åº¦æ—¥ã€‚</p>`,
            choices: [{ text: "å†å…¥å®®é–€", action: "restart" }]
        },
        "ending_cold": {
            text: `<p style="color:#555;font-size:1.5rem;">ã€çµå±€ï¼šå†·å®®æ·’æ¶¼ã€‘</p><p>ä½ ä¿ä½ä¸€å‘½ï¼Œä½†è¢«å¹½ç¦å†·å®®ã€‚</p>`,
            choices: [{ text: "å«æ¨é‡ä¾†", action: "restart" }]
        },
        "ending_death": {
            text: `<p style="color:black;font-size:1.5rem;">ã€çµå±€ï¼šè³œæ­»ã€‘</p><p>è¨ˆè¬€æ•—éœ²ï¼Œè³œæ¯’é…’ä¸€æ¯ã€‚</p>`,
            choices: [{ text: "å†æ¬¡æŒ‘æˆ°", action: "restart" }]
        }
    };

    function getAppellation() { return currentState.favor > 70 ? "æ„›å¦ƒ" : (currentState.favor < 30 ? "è³¤äºº" : "è²´å¦ƒ"); }
    function startGame() {
        document.getElementById('titleScreen').classList.add('hidden');
        resetStats(); renderStats(); renderInventory(); loadScene("background_selection");
    }
    function resetStats() { currentState = { ...initialStats }; currentInventory = []; }
    function renderStats() {
        const statsBar = document.getElementById('statsBar'); statsBar.innerHTML = '';
        checkGameOverConditions();
        for (const [key, val] of Object.entries(currentState)) {
            const div = document.createElement('div'); div.className = 'stat-item';
            div.innerHTML = `<span class="stat-label">${statLabels[key]}</span><span class="stat-value" id="stat-${key}">${val}</span>`;
            statsBar.appendChild(div);
        }
    }
    function renderInventory() {
        const invList = document.getElementById('invList');
        invList.innerHTML = currentInventory.length === 0 ? '<span style="color:#999;">æš«ç„¡</span>' : currentInventory.map(item => `<span class="inv-item">${item}</span>`).join('');
    }
    function updateStats(effects) {
        if (!effects) return;
        for (const [key, change] of Object.entries(effects)) {
            if (change === 0) continue;
            currentState[key] += change;
            if (currentState[key] > 100) currentState[key] = 100;
            if (currentState[key] < 0) currentState[key] = 0;
            const sign = change > 0 ? '+' : '';
            const colorClass = change > 0 ? 'val-up' : 'val-down';
            showFloatText(key, sign + change, colorClass);
        }
        renderStats();
    }
    function showFloatText(key, text, colorClass) {
        const statEl = document.getElementById(`stat-${key}`);
        if (!statEl) return;
        const rect = statEl.getBoundingClientRect();
        const floatEl = document.createElement('div');
        floatEl.className = `float-text ${colorClass}`;
        floatEl.innerText = text;
        floatEl.style.left = (rect.left + 10) + 'px';
        floatEl.style.top = (rect.top + 20) + 'px';
        document.body.appendChild(floatEl);
        setTimeout(() => floatEl.remove(), 1500);
    }
    function checkGameOverConditions() {
        if (currentSceneId === "background_selection" || currentSceneId.startsWith("ending_")) return false;
        let reason = "";
        if (currentState.favor <= 0) reason = "è–å¯µè€—ç›¡ï¼Œè¢«è³œæ­»ã€‚";
        else if (currentState.health <= 0) reason = "ç—…é‡èº«äº¡ã€‚";
        else if (currentState.family <= 0) reason = "å®¶æ—æŠ„æ–¬ï¼Œè¢«æ‰“å…¥å†·å®®ã€‚";
        if (reason) { triggerGameOver(reason); return true; }
        return false;
    }
    function triggerGameOver(reason) {
        document.getElementById('storyContent').innerHTML = `<p style="color:#c62828;font-weight:bold;font-size:1.5rem;text-align:center;">ã€æ•—å±€ã€‘</p><p style="text-align:center;">${reason}</p>`;
        document.getElementById('choicesArea').innerHTML = `<button class="choice-btn" onclick="startGame()">é‡æ–°å…¥å®®</button>`;
    }
    function loadScene(sceneId) {
        currentSceneId = sceneId; const scene = scenes[sceneId];
        document.getElementById('storyContent').innerHTML = scene.text;
        document.getElementById('storyArea').scrollTop = 0;
        const choicesArea = document.getElementById('choicesArea'); choicesArea.innerHTML = '';

        scene.choices.forEach(choice => {
            const btn = document.createElement('button'); btn.className = 'choice-btn';
            let disabled = false, reqText = '';
            
            if (choice.requirement) {
                const { stat, val } = choice.requirement;
                if (currentState[stat] <= val) { disabled = true; reqText = `(éœ€${statLabels[stat].split(' ')[1]}>${val})`; }
            }
            if (choice.reqItem) {
                if (!currentInventory.includes(choice.reqItem)) { disabled = true; reqText = `<span class="req-item"> (éœ€: ${choice.reqItem})</span>`; }
                else { reqText = `<span class="highlight-success"> ã€æŒæœ‰ã€‘</span>`; }
            }

            let html = `<div class="choice-btn-row"><span>${choice.text}</span><span class="choice-req">${reqText}</span></div>`;
            let effectHint = [];
            if (choice.effect) {
                for (const [k, v] of Object.entries(choice.effect)) {
                    effectHint.push(`<span style="color:${v > 0 ? '#2e7d32' : '#c62828'}">${statLabels[k].split(' ')[1]}${v > 0 ? 'â¬†' : 'â¬‡'}</span>`);
                }
            }
            if (choice.isRisk) effectHint.push(`âš ï¸ æ©Ÿç‡: ${statLabels[choice.riskStat].split(' ')[1]}`);
            if (choice.gainItem) effectHint.push(`<span style="color:#8B4513">ğŸ ç²å¾—: ${choice.gainItem}</span>`);
            if (effectHint.length > 0) html += `<span class="choice-effect">${effectHint.join('  ')}</span>`;

            btn.innerHTML = html; btn.disabled = disabled;
            btn.onclick = () => handleChoice(choice);
            choicesArea.appendChild(btn);
        });
    }
    function handleChoice(choice) {
        if (choice.action === "restart") { startGame(); return; }
        const eventLog = document.createElement('div'); eventLog.className = 'event-log';
        let nextSceneId = choice.nextScene, resultText = choice.resultText || "";

        if (choice.isRisk) {
            const roll = Math.floor(Math.random() * 100);
            if (roll < currentState[choice.riskStat]) {
                nextSceneId = choice.successScene; eventLog.innerHTML = `<span class="highlight-success">(åˆ¤å®šæˆåŠŸ)</span> ` + resultText;
            } else {
                nextSceneId = choice.failScene; 
                // é€™è£¡åŠ å…¥ç‰¹æ®Šçš„å¤±æ•—æ–‡æœ¬åˆ¤å®š
                let failText = "é‹æ°£ä¸ä½³...";
                if (choice.text.includes("ç»èˆ")) failText = "ä½ ç›¡åŠ›ä¸€èˆï¼Œä½†è…³ä¸‹ä¸€å€‹è¸‰è¹Œï¼Œå¼•å¾—å¤ªåçšºçœ‰ã€‚";
                
                eventLog.innerHTML = `<span class="highlight-danger">(åˆ¤å®šå¤±æ•—)</span> ${failText}`;
            }
        } else { eventLog.innerText = resultText; }

        updateStats(choice.effect);
        if (choice.gainItem && !currentInventory.includes(choice.gainItem)) {
            currentInventory.push(choice.gainItem); eventLog.innerHTML += `<br><span style="color:#8B4513;">ğŸ ç²å¾—é“å…·ï¼š${choice.gainItem}</span>`; renderInventory();
        }
        if (choice.removeItem) { currentInventory = currentInventory.filter(i => i !== choice.removeItem); renderInventory(); }

        if (checkGameOverConditions()) return;
        document.getElementById('storyContent').appendChild(eventLog);
        document.getElementById('storyArea').scrollTop = document.getElementById('storyArea').scrollHeight;
        document.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);
        setTimeout(() => loadScene(nextSceneId), 1500);
    }
</script>
</body>
</html>